
【＃タイトル】tpac記法

■概要

　tpac記法は、改行を含む長めの文章や、親子関係を簡単に記述するための記法です。
　名称は、長めの文章(Text)と親子関係(Parent And Child)に由来しています。

　以下のとおり、既存の記法では難しいことから独自に作成しました。

・XMLは、長いテキストや階層的なデータ構造を実現できますが、表現が冗長です。
・JSONや YAMLは、階層的なデータ構造を実現できますが、長いテキストの記述には向いていません。
・Groovy DSLは、文法的な誤りを含むテキストを記述できません。

　tpac文書は【リンク：TeaServerクラス：/gitdoc/tpac/groovydoc/io/github/longfish801/tpac/TeaServer.html】で解析できます。

■サンプル

　以下にtpac文書のサンプルを示します。
　ファイル【リンク：sample/sample.tpac】として保存したとします。

-----
#! tpac account
# 山田太郎のアカウントです。
#> kind personal
#>> elem name 山田太郎
#>> elem age 19
#>> map family
#-father 山田一郎
#-mother 山田花子
#> elem remarks
編集中。
後で見直します。
#

#> elem hobby
#_国内旅行
#_
#	_Java
#	_Groovy
#_
読書も好きです。
推理小説をよく読みます。
#!!
-----

　上記の tpac文書を読みこんで、assertで内容を確認するスクリプト【リンク：sample/tpac.groovy】は以下の内容となります。

-----
@GrabResolver(name = 'longfish801 github repositry', root = 'https://longfish801.github.io/maven/')
@Grab('io.github.longfish801:tpac:0.2.00')
@GrabExclude('org.codehaus.groovy:groovy-all')

import io.github.longfish801.tpac.TeaServer;
import io.github.longfish801.tpac.element.TeaDec;
import io.github.longfish801.tpac.element.TpacText;

try {
	// tpac文書を解析し、宣言を参照します
	TeaServer server = new TeaServer();
	server.soak(new File('account.tpac'));
	TeaDec dec = server['tpac:account'];
	
	// 読込内容を確認します
	assert dec.key == 'tpac:account';
	assert dec.comment.handle == [ '山田太郎のアカウントです。' ];
	assert dec.lowers['kind:personal'].lowers['elem:name'].scalar == '山田太郎';
	assert dec.lowers['kind:personal'].lowers['elem:age'].scalar == 19;
	assert dec.lowers['kind:personal'].lowers['map:family'].map == 
		[ 'father': '山田一郎', 'mother': '山田花子' ];
	assert dec.lowers['remarks:'].text == [ '編集中。', '後で見直します。' ] as TpacText;
	assert dec.lowers['guarantor:name'].scalar.refer() == '山田一郎';
	assert dec.lowers['hobby:'].list ==
		[ '国内旅行', [ 'Java', 'Groovy' ], [ '読書も好きです。', '推理小説をよく読みます。' ] as TpacText ];
	
} catch (TeaServer.TeaServerParseException exc){
	println "tpac文書の読込に失敗しました。exc=${exc}";
}
-----

　上記の tpac文書を、以下の XMLに変換できます。
　ファイル【リンク：sample/sample.xml】として保存したとします。

-----
#! tea アッサム
-----

　宣言よりも前に記述された内容は無視します。
　ハンドルと同様に、宣言もスカラー値やテキストを保持することができます。

■宣言終端

　tpac文書を明示的に終了したい場合は、以下の行を記述してください。
　宣言終端より後に記述された内容は無視します。

-----
#!!
-----

■ハンドル

　宣言以降にハンドルを記述してください。
　ハンドルは、スカラー値とマップを保持することができます。
　複数のハンドルを記述できます。
　ハンドル同士に親子関係を持たせることができます。

□ハンドル開始行と親子関係

　ハンドル開始行には、行頭に「#[数値]>」を記述してください。
　[数値]は階層を表します。１以上の値を指定してください。
　たとえば以下のように親子関係を表現できます。

-----
#1> handle 親--
#2> handle 子1
#3> handle 孫11
#2> handle 子2
#2> handle 子3
#3> handle 孫31
#3> handle 孫32
-----

　階層が 1～3の場合のみ、省略記法が使えます。
　以下は、上記の例と同じ階層関係を表しています。

-----
#> handle 親--
#>> handle 子1
#>>> handle 孫11
#>> handle 子2
#>> handle 子3
#>>> handle 孫31
#>>> handle 孫32
-----

□ハンドルの形式

　ハンドル開始行にはタグ名、名前、スカラー値を指定します。
　タグ名、名前、スカラー値を半角スペース区切りで記述します。
　タグ名の前にも半角スペースが必要なことに留意してください。

　タグ名は必須です。
　同じ宣言あるいは親ハンドルに属す複数のハンドルがあるとき、タグ名は重複しても構いません。
　タグ名に改行コード、半角スペース、半角シャープ(#)、半角スラッシュ(/)、半角コロン(:)は使用できません。

　名前は省略可（空文字扱い）です。同じタグ名で、名前を省略できるハンドルはひとつだけとなります。
　同じ宣言あるいは親ハンドルに属す複数のハンドルがあるとき、タグ名と名前の組合せに重複は許されません。
　名前に改行コード、半角スペース、半角シャープ(#)、半角スラッシュ(/)、半角コロン(:)は使用できません。

　スカラー値は省略可です。名前の後に、半角スペース区切りで記述してください。
　名前を省略したときはスカラー値を指定することはできません。

　ハンドル開始行の次行からマップを記述できます。省略可です。
　たとえば以下のハンドルは、文字列'吾輩は猫である'というスカラー値、[author: '夏目漱石', publisher: '新潮社', text: "吾輩は猫である。\n名前はまだ無い。" ]というマップを持っています。

-----
#> book ISBN-999 吾輩は猫である
#-author 夏目漱石
#-publisher 新潮社
#-text
吾輩は猫である。
名前はまだ無い。
-----

　ひとつだけ、キーを省略したテキストをマップの先頭に記述することができます。
　このときキーは空文字扱いとなります。
　たとえば以下のハンドルは、[ '': "吾輩は猫である。\n名前はまだ無い。" ]というマップを持っています。

-----
#> book ISBN-999
吾輩は猫である。
名前はまだ無い。
-----

　ハンドルが保持する値は、以下の初期値を持っています。

・スカラー値：Null値
・マップ：空マップ

■ハンドル終端

　明示的にハンドルの終端を示すには「#」のみの行を記述してください。
　終端から次のハンドル開始行までの記述は無視します。

■スカラー値
□データ型

　以下のデータ型のスカラー値を指定できます。

・Null値（固定文字列"null"）
・真偽（固定文字列"true", "false"）
・整数（12, 0, -3など）
	・正規表現「\-?\d+」とマッチする文字列。
	  java.lang.Integerとして保持します。
・浮動小数点（0.05, -1.0など）
	・正規表現「\-?\d+\.\d+」とマッチする文字列。
	  java.math.BigDecimalとして保持します。
・参照（@始まり）
・正規表現（:始まり）
・文字列（_始まり、あるいは上記以外）

　スカラー値は tpac文書を解析した時点で、目的のデータ型に変換します。
　参照だけは遅延評価します。値を参照されたときに初めて参照先の値を取得します。

□参照

　参照は、他のハンドルやハンドルが保持する値を参照することができます。

・必ず半角アットマークから開始します。
・タグ名と名前を半角コロンで連結してください。
  名前が省略されている場合は空文字扱いとなります。
  半角コロンがない場合はタグ名のみ指定（名前は空文字）扱いとみなします。
・文書とハンドルの親子関係は半角スラッシュで連結してください。
・絶対パス（先頭に文書を指定）する場合は半角スラッシュを文書の前に付与します。
・相対的に上位のハンドルを指すには「..」を利用してください。
・ハンドルが保持する値を参照する場合、半角シャープの後にたとえば以下を続けてください。
  これは Groovyスクリプトとして evalした値となります。
	・スカラー値ならば固定文字列"scalar"
	・マップならば固定文字列"map"

　たとえば以下の文書内に対して「@/gconfig:config/account:t-yamada/language#map[''][0]」を参照すると「日本語」が返ります。

-----
#! gconfig config
#> account t-yamada 山田太郎
#>> language
日本語
英語
-----

□文字列

　明示的に文字列であることを示したい場合は、行頭を半角アンダーバー（_）で開始してください。
　空文字を指定したい場合は半角アンダーバーのみを記述してください。
　行頭を半角アンダーバーで開始した場合、Javaのエスケープシーケンスが使えます。

■テキスト

　改行を含む文字列は、直前に改行を入れて記述してください。
　テキストの各行は、先頭を「#」以外の文字で始める必要があります。
　先頭に「#」がある場合のみ、エスケープのためタブでインデントしてください。
　他のハンドルやコレクションが開始すれば、そこで終端とみなします。
　たとえば以下なら "吾輩は猫である。\n# 名前はまだ無い。\n"となります。

-----
## novel
吾輩は猫である。
	# 名前はまだ無い。
-----

　テキストは、各行を要素とするリストとして保持します。

■マップ

　マップは、各行の行頭に「#-」を記述し、その後にキーとスカラー値を記述します。
　キーとスカラー値は半角スペースで区切ります。
　キーに改行コード、半角スペース、半角シャープ(#)、半角スラッシュ(/)、半角コロン(:)は使用できません。
　キーは必ず文字列となる（他のデータ型をキーとできない）ことに注意してください。

-----
#-age 19
#-country Japan
-----

　テキストを値とするときは、キーの後に改行を入れて記述してください。

-----
#-memo
日曜日に工事がある。
本屋へ行くのはその後で。
-----

■コメント

　ハンドル開始行、テキスト、コレクションの後にコメントを記述できます。
　コメントは行頭を「#」で始めてください。
　「#」の後に半角スペースが必要です。
　コメントは、その直上にある要素へのコメントとみなします。

以上
